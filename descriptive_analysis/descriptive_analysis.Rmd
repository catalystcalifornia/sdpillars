---
title: "San Diego RIPA Data Pillars Project"
subtitle: "Descriptive Analysis"
author: "Catalyst California"
output:
  html_document:
    css: "W:\\RDA Team\\R\\cc_brandguide.css"
    toc: yes
    toc_depth: 2
    toc_float: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)


list.of.packages <- c("usethis", "highcharter", "tidyverse", "sf", "leaflet", "sp", "htmltools", "magrittr", "flextable", "htmlwidgets")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

#### Load libraries ####
library(usethis)
library(highcharter)
library(tidyverse)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(magrittr)
#library(leaflegend) # customize legends to change shapes:: commenting out because not needed for high injury network maps for now
library(flextable)
library(htmlwidgets)

#add function that better fits the tables to the page    
    FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
    }

#### Add database connection ####

source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("rjs_pillars")

# read in tables from postgres

stops<-dbGetQuery(con, "SELECT * FROM rel_stops")
reason<-dbGetQuery(con, "SELECT * FROM rel_stopreason")
person<-dbGetQuery(con, "SELECT * FROM rel_persons")

```

Before engaging in detailed analysis regarding the projectâ€™s research questions, we will first run general frequencies of SDPD stops to get a sense of overall trends. This helps us determine if our expected findings are likely to show up in the data and allows us to identify any trends we did not expect. The analysis will include: 

General counts and percents of SDPD stops by key fields in RIPA data, e.g., stop reason, stop result, calls for service, race, age, searches, officer assignment. 

General counts and percents of stops by Gang Suppression Unit and Special Operations Unit (if available) by key fields in RIPA data, e.g., stop reason, stop result, calls for service, race, age, searches. 

Quick map of stop counts by police beat and for Gang Suppression Unit/Special Operations Unit. 

# SDPD Stop Level Exploration

## SDPD Calls for Service versus Officer-initiated

```{r}

# prep data 

cfs<-stops%>%
  select(stop_id, stop_in_response_to_cfs, stopduration)%>%
  mutate(Total=n())%>%
  group_by(stop_in_response_to_cfs)%>%
  mutate(Count=n(),
         Percent=Count/Total*100,
         'Average Stop Time (Mins)' = mean(stopduration, na.rm = FALSE),
            'Median Stop Time (Mins)'=   median(stopduration,na.rm = FALSE),
             'Min Stop Time (Mins)'=min(stopduration,na.rm = FALSE),
            'Max Stop Time (Mins)'=max(stopduration,na.rm = FALSE),
             'Total Time (Mins)'= sum(stopduration)
         )%>%
  slice(1)%>%
  select(-c(stop_id, stopduration))%>%
  mutate(stop_in_response_to_cfs=ifelse(stop_in_response_to_cfs %in% 0, 'No', 'Yes'))%>%
  rename('Call for Service'='stop_in_response_to_cfs')
         


#create and style flextable

  flextable(cfs) %>% 
colformat_double(j = c("Percent", "Average Stop Time (Mins)",'Median Stop Time (Mins)',
                       'Min Stop Time (Mins)','Max Stop Time (Mins)', 'Total Time (Mins)'), digits = 1)%>% 
  set_caption('Stop Counts and Rates by Response to Service Call') %>% 
  theme_vanilla() 



```

## SDPD stops by stop reason

```{r}

# for the rel_stopreason table, it seems like the reason why some people show up in multiple rows is because
# there are different values for 'reason_for_stop_text' or 'reason_for_stop_detail' or 'reason_stop_explaination' BUT the 'reason_for_stop' value remains the same. Which is ultimately what we want for our analysis. So my goal is to create a flattened version of rel_stopreason that shows each person once for their stop reason. UNLESS a person shows up more than once because there is more than one unique stop reason

test<-reason%>%
  group_by(stop_id, person_id)%>%
  mutate(count=n())


reason_p<-person%>%
  left_join(reason%>%select(stop_id, person_id, reason_for_stop))%>%
  select(stop_id, person_id, reason_for_stop)%>%
  group_by(stop_id, person_id, reason_for_stop)%>%
  slice(1)


```

## SDPD stops by stop result

## SDPD stops by age

## SDPD stops by race

## SDPD stops that were searches and what searches resulted in (hit rates)

# SDPD Gang Suppression Unit Comparisons

## Count and rate of stops across different units

```{r}

units<-stops%>%
  select(stop_id, officer_assignment_key, assignment)%>%
  mutate(Total=n())%>%
  group_by(assignment)%>%
  summarise(Total=Total,
            Count=n(),
            Percent=Count/Total*100)%>%
  slice(1)%>%
  arrange(-Percent)%>%
  rename('Patrol Assignment'='assignment')

#create and style flextable

  flextable(units) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Stops by Patrol Assignment Type') %>% 
  theme_vanilla() %>%
  width(j=1,3.5,unit="in")


```

## Gang Suppression Unit Calls for service versus Officer-initiated

```{r}

# prep data 

cfs_gang<-stops%>%
  filter(assignment=='Gang enforcement')%>%
  select(stop_id, stop_in_response_to_cfs, stopduration)%>%
  mutate(Total=n())%>%
  group_by(stop_in_response_to_cfs)%>%
  mutate(Count=n(),
         Percent=Count/Total*100,
         'Average Stop Time (Mins)' = mean(stopduration, na.rm = FALSE),
            'Median Stop Time (Mins)'=   median(stopduration,na.rm = FALSE),
             'Min Stop Time (Mins)'=min(stopduration,na.rm = FALSE),
            'Max Stop Time (Mins)'=max(stopduration,na.rm = FALSE),
             'Total Time (Mins)'= sum(stopduration)
         )%>%
  slice(1)%>%
  select(-c(stop_id, stopduration))%>%
  mutate(stop_in_response_to_cfs=ifelse(stop_in_response_to_cfs %in% 0, 'No', 'Yes'))%>%
  rename('Call for Service'='stop_in_response_to_cfs')
         


#create and style flextable

  flextable(cfs_gang) %>% 
colformat_double(j = c("Percent", "Average Stop Time (Mins)",'Median Stop Time (Mins)',
                       'Min Stop Time (Mins)','Max Stop Time (Mins)', 'Total Time (Mins)'), digits = 1)%>% 
  set_caption('Stop Counts and Rates by Response to Service Call from Gang Suppression Unit') %>% 
  theme_vanilla() 




```

## Gang Suppression Unit stops by stop reason

## Gang Suppression Unit stops by stop result

## Gang Suppression Unit stops by age

## Gang Suppression Unit stops by race

# Map

