---
title: "San Diego RIPA Data Pillars Project"
subtitle: "Descriptive Analysis"
author: "Catalyst California"
output:
  html_document:
    css: "W:\\RDA Team\\R\\cc_brandguide.css"
    toc: yes
    toc_depth: 2
    toc_float: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)


list.of.packages <- c("usethis", "highcharter", "tidyverse", "sf", "leaflet", "sp", "htmltools", "magrittr", "flextable", "htmlwidgets")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

#### Load libraries ####
library(usethis)
library(highcharter)
library(tidyverse)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(magrittr)
#library(leaflegend) # customize legends to change shapes:: commenting out because not needed for high injury network maps for now
library(flextable)
library(htmlwidgets)

#add function that better fits the tables to the page    
    FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
    }

#### Add database connection ####

source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("rjs_pillars")

# read in tables from postgres

stops<-dbGetQuery(con, "SELECT * FROM rel_stops") 

# Add column just for year of stop to stops table
stops$Year = substr(stops$date_stop, 1, 4)


reason<-dbGetQuery(con, "SELECT * FROM rel_stopreason")
person<-dbGetQuery(con, "SELECT * FROM rel_persons")

```

Before engaging in detailed analysis regarding the projectâ€™s research questions, we will first run general frequencies of SDPD stops to get a sense of overall trends. This helps us determine if our expected findings are likely to show up in the data and allows us to identify any trends we did not expect. The analysis will include: 

General counts and percents of SDPD stops by key fields in RIPA data, e.g., stop reason, stop result, calls for service, race, age, searches, officer assignment. 

General counts and percents of stops by Gang Suppression Unit and Special Operations Unit (if available) by key fields in RIPA data, e.g., stop reason, stop result, calls for service, race, age, searches. 

Quick map of stop counts by police beat and for Gang Suppression Unit/Special Operations Unit. 

--combine all tables by 'all units' + 'just gang suppression unit' 

# Calls for Service versus Officer-initiated

Analysis cut by all unit types:

```{r}

# prep data 

cfs<-stops%>%
  select(stop_id, Year, stop_in_response_to_cfs, stopduration)%>%
  filter(Year=='2022')%>%
  mutate(Total=n())%>%
  group_by(stop_in_response_to_cfs)%>%
  mutate(Count=n(),
         Percent=Count/Total*100,
         'Average Stop Time (Mins)' = mean(stopduration, na.rm = FALSE),
            'Median Stop Time (Mins)'=   median(stopduration,na.rm = FALSE),
             'Min Stop Time (Mins)'=min(stopduration,na.rm = FALSE),
            'Max Stop Time (Mins)'=max(stopduration,na.rm = FALSE),
             'Total Time (Mins)'= sum(stopduration)
         )%>%
  slice(1)%>%
  select(-c(stop_id, stopduration))%>%
  mutate(stop_in_response_to_cfs=ifelse(stop_in_response_to_cfs %in% 0, 'No', 'Yes'))%>%
  rename('Call for Service'='stop_in_response_to_cfs')%>%
  mutate(Assignment = 'All units')%>%
  relocate(Assignment, .after = Year)
         


#create and style flextable

  flextable(cfs) %>% 
colformat_double(j = c("Percent", "Average Stop Time (Mins)",'Median Stop Time (Mins)',
                       'Min Stop Time (Mins)','Max Stop Time (Mins)', 'Total Time (Mins)'), digits = 1)%>% 
  set_caption('Stop Counts and Rates by Response to Service Call for All Units') %>% 
  theme_vanilla() 

```

Analysis filtered for gang suppression unit:

```{r}

# prep data 

cfs_gu<-stops%>%
  select(stop_id, Year, assignment, stop_in_response_to_cfs, stopduration)%>%
  filter(Year=='2022' & assignment =='Gang enforcement')%>%
  mutate(Total=n())%>%
  group_by(stop_in_response_to_cfs)%>%
  mutate(Count=n(),
         Percent=Count/Total*100,
         'Average Stop Time (Mins)' = mean(stopduration, na.rm = FALSE),
            'Median Stop Time (Mins)'=   median(stopduration,na.rm = FALSE),
             'Min Stop Time (Mins)'=min(stopduration,na.rm = FALSE),
            'Max Stop Time (Mins)'=max(stopduration,na.rm = FALSE),
             'Total Time (Mins)'= sum(stopduration)
         )%>%
  slice(1)%>%
  select(-c(stop_id, stopduration))%>%
  mutate(stop_in_response_to_cfs=ifelse(stop_in_response_to_cfs %in% 0, 'No', 'Yes'))%>%
  rename('Call for Service'='stop_in_response_to_cfs',
         'Assignment'='assignment')
         


#create and style flextable

  flextable(cfs_gu) %>% 
colformat_double(j = c("Percent", "Average Stop Time (Mins)",'Median Stop Time (Mins)',
                       'Min Stop Time (Mins)','Max Stop Time (Mins)', 'Total Time (Mins)'), digits = 1)%>% 
  set_caption('Stop Counts and Rates by Response to Service Call for Gang Suppression Unit') %>% 
  theme_vanilla() 

```


## Total Officer-Intiated Stops Over Time

```{r}

# calculate total number of officer initiated stops across all units

count<-stops%>%
  filter(stop_in_response_to_cfs==0)%>%
  select(Year, stop_id)%>%
  group_by(Year)%>%
  mutate('All Units Total'=n())%>%
  slice(1)%>%
  select(-stop_id)

# calculate total number of officer initiated stops for gang suppresion unit

count_gu<-stops%>%
  filter(stop_in_response_to_cfs==0 )%>%
  filter(grepl('Gang enforcement', assignment))%>%
  select(Year, stop_id)%>%
  group_by(Year)%>%
  mutate('Gang Suppression Unit Total'=n())%>%
  slice(1)

# combine both unit tables

count<-count%>%
  left_join(count_gu%>%select(Year, 'Gang Suppression Unit Total'))
  
  #create and style flextable

  flextable(count) %>% 
  set_caption('Total Count of Officer-Initiated Stops Over Time') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in")
  
  
```

## Total Officer-Intiated Stops in 2022

```{r}

units22<-stops%>%
  filter(stop_in_response_to_cfs==0)%>%
  select(Year, stop_id, officer_assignment_key, assignment)%>%
  group_by(Year)%>%
  mutate(Total=n())%>%
  group_by(Year, assignment)%>%
  summarise(Total=Total,
            Count=n(),
            Percent=Count/Total*100)%>%
  slice(1)%>%
  arrange(-Percent)%>%
  rename('Patrol Assignment'='assignment')%>%
  filter(grepl('2022', Year))


#create and style flextable

  flextable(units22) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Stops by Patrol Assignment Type in 2022') %>% 
  theme_vanilla() %>%
  width(j=2,2.5,unit="in")


```


# Stop Reason and Rersults

## Stops by stop reason

```{r}

# for the rel_stopreason table, it seems like the reason why some people show up in multiple rows is because
# there are different values for 'reason_for_stop_text' or 'reason_for_stop_detail' or 'reason_stop_explaination' BUT the 'reason_for_stop' value remains the same. Which is ultimately what we want for our analysis. So my goal is to create a flattened version of rel_stopreason that shows each person once for their stop reason. UNLESS a person shows up more than once because there is more than one unique stop reason

# similarliy seeing now that rel_persons also has multiple rows for people who have more than 1 perceived age or gender


# Continuing analysis for now:

reason_p<-person%>%
  
  # join stops table so we can filter for year / cfs
  
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  
  # left join reasons -filtered for year/cfs - to get stop reason
  
  left_join(reason%>%
              left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs ))%>%
              filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
              select(stop_id, person_id, reason_for_stop))%>%
  
  select(Year, stop_id, person_id, reason_for_stop)

# Run a quick test to see if one person/stop_id combo has more than 1 unique reason_for_stop

test<-reason_p %>%
  group_by(stop_id, person_id) %>% 
  mutate(same = +(n_distinct(reason_for_stop) == 1)) %>% 
  ungroup()

 table(test$same) # all 701063 rows return same==1 which means there are not any people who were stopped for different reason_for_stop

# Calculate estimates

reason_p<-reason_p%>%
  mutate(Total=n())%>%
  group_by(reason_for_stop)%>%
    mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id))%>%
  rename( 'Reason for stop'='reason_for_stop')%>%
  arrange(-Percent)
  

# create table

  flextable(reason_p) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Stops by Stop Reason') %>% 
  theme_vanilla() %>%
  width(j=1,3.65,unit="in")


```

## Stops by stop result

## Hit Rates

# Demographics of Stops

## Stops by age

## Stops by race

```{r}



```


# Map

