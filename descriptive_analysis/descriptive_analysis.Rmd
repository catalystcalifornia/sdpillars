---
title: "San Diego RIPA Data Pillars Project"
subtitle: "Descriptive Analysis"
author: "Catalyst California"
output:
  html_document:
    css: "W:\\RDA Team\\R\\cc_brandguide.css"
    toc: yes
    toc_depth: 2
    toc_float: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)


list.of.packages <- c("usethis", "highcharter", "tidyverse", "sf", "leaflet", "sp", "htmltools", "magrittr", "flextable", "htmlwidgets")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

#### Load libraries ####
library(usethis)
library(highcharter)
library(tidyverse)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(magrittr)
library(flextable)
library(htmlwidgets)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(scales)

#add function that better fits the tables to the page    
    FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
    }

#### Add database connection ####

source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("rjs_pillars")

# read in tables from postgres

stops<-dbGetQuery(con, "SELECT * FROM rel_stops") 

# Add column just for year of stop to stops table
stops$Year = substr(stops$date_stop, 1, 4)


reason<-dbGetQuery(con, "SELECT * FROM rel_stopreason")
person<-dbGetQuery(con, "SELECT * FROM rel_persons")
result<-dbGetQuery(con, "SELECT * FROM rel_stopresult")
search<-dbGetQuery(con, "SELECT * FROM rel_basis_search")
contra<-dbGetQuery(con, "SELECT * FROM rel_contrabands_evidences")
race<-dbGetQuery(con, "SELECT * FROM rel_races_recode")
beats<-st_read(con, query = "SELECT * FROM sangis_sdpd_beats_2023")%>%
  mutate(beat=as.character(beat))
div<-dbGetQuery(con, "SELECT * FROM sangis_sdpd_divisions_2023")%>%
  select(-geom)

# Prep beats and stop crosswalk

# join divisions to the beats table just to get the full division name
beats_div<-beats%>%
  left_join(div%>%select(div_num, div_name), by=c("div"="div_num"))%>%
  select(beat, name, div, div_name)%>%
    as.data.frame()%>%
  select(-geom)%>%
  rename('beat_name' = 'name')%>%
  group_by(beat)%>%
  slice(1)%>%
  mutate(beat_name=ifelse(beat %in% "511", 'BARRIO LOGAN', beat_name))%>% # there was a data entry error where beat=511 showed up twice, once with the beat_name included, and once where beat_name was NA. So I manually re-added the beat_name
  ungroup()

# join updated beats-div crosswalk to stops data

beats_stop<-stops%>%
  left_join(beats_div%>%select(beat, div, div_name), by=c("beat"="beat"))

# analyze data 

# explore stops where div = NA. These look to be where beat = 999, Unknown 999 but lets confirm

na<-beats_stop%>%
  select(stop_id, Year, div_name, stop_in_response_to_cfs, stopduration)%>%
  filter(Year=='2022')%>%
  group_by(div_name)%>%
  mutate(Total=n())%>%
  filter(is.na(div_name))%>%
  left_join(stops%>%select(stop_id, beat))

# table(na$beat) # there are mostly beat=999, which is unknown. There is also no beat=125 in the sdpd beats df. I think it is ok to recode these all to just 'unknown beat' 

```

Before engaging in a detailed analysis of SDPD patrol activity as outlined in the research plan, we created this descriptive analysis to explore overall trends in the SDPD RIPA data. This helps us determine if our expected findings are likely to show up in the data and allows us to identify any trends we did not expect. We include basis tallies on each of the following:

* [Officer-initiated stops](#Number of Officer-Initiated Stops)
* [Time spent on stops by calls for service or officer-initiated stops](#Time Spent on Calls for Service versus Officer-initiated)
* Officer-initiated stops by stop reason
* Officer-initiated stops by stop result
* Officer-initiated stops by hit rates
* Officer-initiated stops by age
* Officer-initiated stops by race
* Officer-initiated stops by police beat

For each, we analyze SDPD stops overall and, where applicable, by assignment (gang enforcement) and SDPD division. Other than one analysis about stops over time, we focus on stops made in 2022. The numbers included in this analysis are preliminary and subject to change based on further analysis and review. Particularly, the reported time spent on stops will change as we complete outlier analysis to account for errors in the data.

# Total Number of Stops and People Stopped

In 2022, there were __86,632 unique police stops__. Of those stops, __79, 416 were officer-initiated stops.__ Gang enforcement made __420 unique stops__ in 2022. Of those stops, __397 were officer-initiated stops__. 

In 2022, __96,119 people__ were stopped by SDPD, __88,099__ of which were stopped for an officer-initiated stop. Gang enforcement stopped __508 people__ in 2022; __484 people__ were stopped for an officer-initiated stop.  

```{r}

stop_tot<-stops%>%
 filter(Year=='2022')%>%
  group_by(stop_id)%>%
  summarise(count=n())%>%
  mutate(total=sum(count))

stop_tot_cfs<-stops%>%
 filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  group_by(stop_id)%>%
  summarise(count=n())%>%
  mutate(total=sum(count))

stop_tot_gu<-stops%>%
 filter(Year=='2022' & assignment =='Gang enforcement')%>%
  group_by(stop_id)%>%
  summarise(count=n())%>%
  mutate(total=sum(count))


stop_tot_gu_cfs<-stops%>%
 filter(Year=='2022' & assignment =='Gang enforcement' & stop_in_response_to_cfs == 0)%>%
  group_by(stop_id)%>%
  summarise(count=n())%>%
  mutate(total=sum(count))

ppl_tot<-person%>%
  # join stops table so we can filter for year / cfs
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs, assignment ))%>%
  filter(Year=='2022')%>%
  group_by(stop_id, person_id)%>%
  summarise(count=n())%>%
  ungroup()%>%
  mutate(total=sum(count))

ppl_tot_offit<-person%>%
  # join stops table so we can filter for year / cfs
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs, assignment ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs==0)%>%
  group_by(stop_id, person_id)%>%
  summarise(count=n())%>%
  ungroup()%>%
  mutate(total=sum(count))


ppl_tot_gu<-person%>%
  # join stops table so we can filter for year / cfs
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs, assignment ))%>%
  filter(Year=='2022' & assignment == 'Gang enforcement')%>%
  group_by(stop_id, person_id)%>%
  summarise(count=n())%>%
  ungroup()%>%
  mutate(total=sum(count))


ppl_tot_gu_offit<-person%>%
  # join stops table so we can filter for year / cfs
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs, assignment ))%>%
  filter(Year=='2022' & assignment == 'Gang enforcement' & stop_in_response_to_cfs==0)%>%
  group_by(stop_id, person_id)%>%
  summarise(count=n())%>%
  ungroup()%>%
  mutate(total=sum(count))

```

# Number of Officer-Initiated Stops

The following takes a closer look at officer-initiated stops, including trends over time, by police assignment, and by division.

## Over Time

The number of officer-initiated stops across all units peaked in 2019, decreasing between 2020-2022. The COVID-19 pandemic directly impacted police activity, making it unsurprising that there were less stops conducted overall.

SDPD stops under gang enforcement have decreased overtime, with a steep drop-off between 2021-2022. Notably, more officer-initiated stops under gang enforcement were made in 2020 than in 2021 and 2022 combined. The low number of gang enforcement stops could be explained by how agencies are required to record this data under RIPA regulations. Agencies are required to report the assignment of the officer at the time of the stop, not their unit. Gang suppression unit stops are likely under-counted and being made under a different assignment. 
```{r}

# calculate total number of officer initiated stops across all units

count<-stops%>%
  filter(stop_in_response_to_cfs==0)%>%
  select(Year, stop_id)%>%
  group_by(Year)%>%
  mutate('All Units Total'=n())%>%
  slice(1)%>%
  select(-stop_id)

# calculate total number of officer initiated stops for gang suppresion unit

count_gu<-stops%>%
  filter(stop_in_response_to_cfs==0 )%>%
  filter(grepl('Gang enforcement', assignment))%>%
  select(Year, stop_id)%>%
  group_by(Year)%>%
  mutate('Gang Enforcement Total'=n())%>%
  slice(1)

# combine both unit tables

count<-count%>%
  left_join(count_gu%>%select(Year, 'Gang Enforcement Total'))
  
  #create and style flextable

  flextable(count) %>% 
  set_caption('Total Count of Officer-Initiated Stops Over Time') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in")
  
  
```

## By Police Assignment

__Patrol, traffic enforcement, and field operations__ conduct the majority of officer-initiated stops, followed by the 'Other' unit category. While gang enforcement has the third highest rate of officer-initiated stops the overall count is low. This is most likely due to gang enforcement stops being conducted under a different unit assignment.

```{r}

units22<-stops%>%
  filter(stop_in_response_to_cfs==0)%>%
  select(Year, stop_id, officer_assignment_key, assignment)%>%
  group_by(Year)%>%
  mutate(Total=n())%>%
  group_by(Year, assignment)%>%
  summarise(Total=Total,
            Count=n(),
            Percent=Count/Total*100)%>%
  slice(1)%>%
  arrange(-Percent)%>%
  rename('Patrol Assignment'='assignment')%>%
  filter(grepl('2022', Year))


#create and style flextable

  flextable(units22) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Stops by Patrol Assignment Type in 2022') %>% 
  theme_vanilla() %>%
  width(j=2,2.5,unit="in")


```

## By SDPD Division

High rates of officer-initiated stops are consistent across all police divisions. The highest number of officer-initiated stops occurs in the __Central Division__ while the highest percent of stops in the __Northwestern Division__ are made for officer-initiated reasons. These numbers do not control for the total population in each division.

```{r}

df<-beats_stop%>%
  filter(Year == "2022")%>%
  select(Year, stop_id, div_name, stop_in_response_to_cfs)%>%
  group_by(div_name)%>%
  mutate(Total=n())%>%
  group_by(div_name, stop_in_response_to_cfs)%>%
  summarise(Year,
            Total=Total,
            Count=n(),
            Percent=Count/Total*100)%>%
  slice(1)%>%
    mutate(div_name=ifelse(is.na(div_name), 'UNKNOWN DIVISION', div_name))%>%
  mutate(stop_in_response_to_cfs=ifelse(stop_in_response_to_cfs %in% 0, 'No', 'Yes'))
# %>%
#   rename('Call for Service'='stop_in_response_to_cfs')%>%
#   rename('Division Name'='div_name')%>%
#   relocate(Year, .before = "Division Name")


# #create and style flextable
# 
#   flextable(df) %>% 
# colformat_double(j = c("Percent"), digits = 1)%>% 
#   set_caption('Total and Rate of Stops by Police Division in 2022') %>% 
#   theme_vanilla() %>%
#   width(j=2,2.3,unit="in")
  
  ggplot(df, aes( x = stop_in_response_to_cfs , y =  Count) ) + 
      geom_bar( stat = "identity", fill="#362178") + 
  geom_text(aes( label = paste0(Count),
                 y= Count),vjust = 1.4, size = 3, color = "white",
             fontface = "bold")+
      facet_wrap( ~ div_name, nrow=2) + 
      xlab("")+
  ylab("Count of Stops by Call for Service")+
    scale_x_discrete(labels = wrap_format(20))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=15),
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=12, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())

```

# Time Spent on Calls for Service versus Officer-initiated

The majority of officer time is spent on __officer-initiated stops__ rather than calls for service with officers spending over 80% of their minutes on officer-initiated stops. This is true across all units, as well as for gang enforcement. __Gang enforcement__ spends more time per stop on average especially for calls for service-an average time of 123.9 minutes compared to 59.3 minutes across all units. The median time gang enforcement spends on officer-initiated stops is slightly higher than the median time all units spend, 15 minutes versus 10 minutes respectively.

## All Units

```{r}

# prep data 

cfs<-stops%>%
  select(stop_id, Year, stop_in_response_to_cfs, stopduration)%>%
  filter(Year=='2022')%>%
  mutate(Total=sum(stopduration,na.rm=TRUE))%>%
  group_by(stop_in_response_to_cfs)%>%
  mutate(Count=sum(stopduration,na.rm=TRUE),
         'Percent Mins'=Count/Total*100,
         'Average Stop Time (Mins)' = mean(stopduration, na.rm = FALSE),
            'Median Stop Time (Mins)'=   median(stopduration,na.rm = FALSE),
             'Min Stop Time (Mins)'=min(stopduration,na.rm = FALSE),
            'Max Stop Time (Mins)'=max(stopduration,na.rm = FALSE),
             'Total Time (Mins)'= Total,
         'Count Mins'=Count
         )%>%
  slice(1)%>%
  select(-c(stop_id, stopduration,Count,Total))%>%
  mutate(stop_in_response_to_cfs=ifelse(stop_in_response_to_cfs %in% 0, 'No', 'Yes'))%>%
  rename('Call for Service'='stop_in_response_to_cfs')%>%
  mutate(Assignment = 'All units')%>%
  relocate(Assignment, .after = Year)%>%
   relocate('Count Mins', .after = 'Call for Service')
         
#create and style flextable

  flextable(cfs) %>% 
colformat_double(j = c("Count Mins", "Percent Mins", "Average Stop Time (Mins)",'Median Stop Time (Mins)',
                       'Min Stop Time (Mins)','Max Stop Time (Mins)', 'Total Time (Mins)'), digits = 1)%>% 
  set_caption('Stop Time by Response to Service Call for All Units') %>% 
  theme_vanilla() 

```

## Gang Enforcement

```{r}

# prep data 

cfs_gu<-stops%>%
  select(stop_id, Year, assignment, stop_in_response_to_cfs, stopduration)%>%
  filter(Year=='2022' & assignment =='Gang enforcement')%>%
 mutate(Total=sum(stopduration,na.rm=TRUE))%>%
  group_by(stop_in_response_to_cfs)%>%
  mutate(Count=sum(stopduration,na.rm=TRUE),
         'Percent Mins'=Count/Total*100,
         'Average Stop Time (Mins)' = mean(stopduration, na.rm = FALSE),
            'Median Stop Time (Mins)'=   median(stopduration,na.rm = FALSE),
             'Min Stop Time (Mins)'=min(stopduration,na.rm = FALSE),
            'Max Stop Time (Mins)'=max(stopduration,na.rm = FALSE),
             'Total Time (Mins)'= Total,
         'Count Mins'=Count
         )%>%
  slice(1)%>%
  select(-c(stop_id, stopduration,Count,Total,assignment))%>%
  mutate(stop_in_response_to_cfs=ifelse(stop_in_response_to_cfs %in% 0, 'No', 'Yes'))%>%
  rename('Call for Service'='stop_in_response_to_cfs')%>%
  mutate(Assignment = 'Gang enforcement')%>%
    relocate(Assignment, .after = Year)%>%
   relocate('Count Mins', .after = 'Call for Service')

#create and style flextable

  flextable(cfs_gu) %>% 
colformat_double(j = c("Count Mins","Percent Mins", "Average Stop Time (Mins)",'Median Stop Time (Mins)',
                       'Min Stop Time (Mins)','Max Stop Time (Mins)', 'Total Time (Mins)'), digits = 1)%>% 
  set_caption('Stop Counts and Rates by Response to Service Call for Gang Enforcement') %>% 
  theme_vanilla() 

```

## By SDPD Division

All SDPD divisions spend more than 75% of its time on __officer-initiated stops__ with a median time of 10-15 minutes spent per stop. The __Central and Northwestern Divisions__ spend over 85% of their time on officer-initiated stops. For stops with unknown divisions, 96.4% of minutes spent on these stops are for officer-initiated stops. There is more variation in the median time spent on stops made for calls for service. Divisions spend a median time of anywhere between 20 and 60 minutes on stops made for calls for service.

```{r}
df<-beats_stop%>%
  select(stop_id, Year, div_name, stop_in_response_to_cfs, stopduration)%>%
  filter(Year=='2022')%>%
  group_by(div_name)%>%
  mutate(Total=sum(stopduration,na.rm=TRUE))%>%  
  mutate(div_name=ifelse(is.na(div_name), 'UNKNOWN DIVISION', div_name))%>%
  group_by(div_name,stop_in_response_to_cfs)%>%
  mutate(Count=sum(stopduration,na.rm=TRUE),
         'Percent Mins'=Count/Total*100,
         'Average Stop Time (Mins)' = mean(stopduration, na.rm = FALSE),
            'Median Stop Time (Mins)'=   median(stopduration,na.rm = FALSE),
             'Min Stop Time (Mins)'=min(stopduration,na.rm = FALSE),
            'Max Stop Time (Mins)'=max(stopduration,na.rm = FALSE),
            'Total Time (Mins)'= Total,
         'Count Mins'=Count
         )%>%
  slice(1)%>%
select(-c(stop_id, stopduration,Count,Total))%>%  mutate(stop_in_response_to_cfs=ifelse(stop_in_response_to_cfs %in% 0, 'No', 'Yes'))%>%
  rename('Call for Service'='stop_in_response_to_cfs')%>%
  rename('Division Name' = 'div_name')

#create and style flextable

  flextable(df) %>%
colformat_double(j = c("Count Mins", "Percent Mins", "Average Stop Time (Mins)",'Median Stop Time (Mins)',
                       'Min Stop Time (Mins)','Max Stop Time (Mins)', 'Total Time (Mins)'), digits = 1)%>%
  set_caption('Stop Counts and Rates by Response to Service Call by Division') %>%
  theme_vanilla()

```


# Stop Reasons

The following explores the most common reasons for officer-initiated stops in 2022. Traffic violations and reasonable suspicion are the most common stop reasons as is common in other local law enforcement agencies.

## By Police Assignment

__Traffic violations__ are the most common stop reason for officer-initiated stops, followed by __reasonable suspicion__, across all police units and for gang enforcement. However, nearly 70% of all officer-initiated stops conducted under gang enforcement are for traffic violations, with only 24% being conducted for reasonable suspicion. Traffic violation stops are a more significant majority of all gang enforcement stops. 

```{r}

# for the rel_stopreason table, it seems like the reason why some people show up in multiple rows is because
# there are different values for 'reason_for_stop_text' or 'reason_for_stop_detail' or 'reason_stop_explaination' BUT the 'reason_for_stop' value remains the same. Which is ultimately what we want for our analysis. So my goal is to create a flattened version of rel_stopreason that shows each person once for their stop reason. UNLESS a person shows up more than once because there is more than one unique stop reason

# similarliy seeing now that rel_persons also has multiple rows for people who have more than 1 perceived age or gender


# Continuing analysis for now:

reason_p<-person%>%
  
  # join stops table so we can filter for year / cfs
  
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs,assignment))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  
  # left join reasons -filtered for year/cfs - to get stop reason
  
  left_join(reason%>%
              left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs ))%>%
              filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
              select(stop_id, person_id, reason_for_stop))%>%
  
  select(Year, stop_id, person_id, reason_for_stop,assignment)

# Run a quick test to see if one person/stop_id combo has more than 1 unique reason_for_stop

test<-reason_p %>%
  group_by(stop_id, person_id) %>% 
  mutate(same = +(n_distinct(reason_for_stop) == 1)) %>% 
  ungroup()

 # while everyone stopped for same reason and just the details vary there are duplicates in the data frame, # 90777 observations, how many unique people?

qa<-reason_p %>%
  group_by(stop_id, person_id) %>% 
  summarise(count=n())%>%
  nrow()

#88099 unique people, let's de-deduplicate the data frame and use it moving forward for reason calcs
reason_p_dedup<-reason_p%>%
  group_by(stop_id,person_id,reason_for_stop,assignment,Year)%>%
  summarise(duplicates=n())%>%
  select(stop_id,person_id,assignment,Year,reason_for_stop,)%>%
  ungroup()


# Calculate estimates -all units

reason_p_all<-reason_p_dedup%>%
  select(stop_id,person_id,Year,reason_for_stop,)%>%
  mutate(Total=n())%>%
  group_by(reason_for_stop)%>%
    mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id))%>%
  rename( 'Reason for stop'='reason_for_stop')%>%
  arrange(-Percent)%>%
  mutate(Assignment='All units')%>% 
  relocate(Assignment, .after = Year)

# Calculate estimates -gang suppression unit only

reason_p_gu<-reason_p_dedup%>%
  select(Year, assignment, stop_id, person_id, reason_for_stop)%>%
  filter(assignment=='Gang enforcement')%>%
  mutate(Total=n())%>%
  group_by(reason_for_stop)%>%
    mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id))%>%
  rename( 'Reason for stop'='reason_for_stop',
          'Assignment' = 'assignment')%>%
  arrange(-Percent)

# final combine

reason_p_table<-reason_p_all%>%
  rbind(reason_p_gu)


# create table

  flextable(reason_p_table) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Officer-Initiated Stops by Stop Reason') %>% 
  theme_vanilla() %>%
  width(j=3,3.65,unit="in")


```

## By SDPD Division

The majority of SDPD divisions conduct officer-initiated stops for __traffic violations__, with the second most common officer-initiated stop being for __reasonable suspicion__. There is no third stop reason that has a rate comparable to traffic Violations or reasonable suspicion.

Notably, the __Southeastern Division__ disproportionately stops for traffic violations relative to reasonable suspicion, along with the __Northwestern, Northeastern, and unknown divisions__. The __Central and Western divisions__ have the highest rates of stops for reasonable suspicion at over 50% of stops made for reasonable suspicion.

```{r fig.height = 7, fig.width = 13}

reason_p_div<-reason_p_dedup%>%
  
  # join unique person reason table  to beats and div
  
  left_join(beats_stop%>%select(stop_id,stop_in_response_to_cfs, div_name),by="stop_id")

# double check the na division names

na<-reason_p_div%>%
  filter(is.na(div_name))%>%
  left_join(stops%>%select(stop_id,  beat))

# table(na$beat) # check what the beat numbers are that have NA division names
# only 4 stops coded to 125 beat in Torrey Pines, consider adding these to Northern division later for now recode the NA division names and join to reasons table

reason_p_div<-reason_p_div%>%
  mutate(div_name=ifelse(is.na(div_name), 'UNKNOWN DIVISION', div_name))

qa<-reason_p_div%>%filter(is.na(div_name))%>%nrow() # test it worked

df<-reason_p_div%>%
  select(Year,div_name,reason_for_stop)%>%
  group_by(div_name)%>%
  mutate(Total=n())%>%
  group_by(div_name, reason_for_stop)%>%
  mutate(Count=n(),
         Percent=Count/Total*100)%>%
  arrange(-Percent,  .by_group = TRUE)%>%
  slice(1)%>%
  filter(grepl('Traffic Violation|Reasonable Suspicion|Knowledge of outstanding arrest warrant/wanted person', reason_for_stop))%>% # replace consent search with knowledge of arrest warrant given higher prevalence in the data
  mutate(reason_for_stop=ifelse(reason_for_stop=='Knowledge of outstanding arrest warrant/wanted person', 'Knowledge of outstanding warrant',reason_for_stop))

# graph

ggplot(df, aes( x = reason_for_stop , y =  Percent) ) + 
      geom_bar( stat = "identity", fill="#362178") + 
  geom_text(aes( label = paste0(round(Percent, digits=1),"%" ),
                 y= Percent),vjust = 1.4, size = 4, color = "white",
            fontface = "bold")+
      facet_wrap( ~ div_name, nrow=2) + 
      xlab("")+
  ylab("Percent of Officer-Initiated Stops (%)")+
    scale_x_discrete(labels = wrap_format(10))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=12),
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=12, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())


```

# Stop Results

## Stop result by police assignment

Across all police units, Citation for Infraction and Warning (verbal or written) are the most common stop results, at 27.5% and 25.8% respectively. These two stop results make up approximately half of all stop results. 

The gang enforcement unit stop results do not mirror the trends across all police units. The most common stop result for a gang enforcement stop is Field Interview Card Completed, comprising of 40.2% of all stop results. Warning (verbal or written) has the second highest rate at 20.6%. 

```{r}

# calculate for all units

result_p<-person%>%
  
  # join result table to person table so we can filter for year / cfs
  
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  
  # left join results -filtered for year/cfs - to get stop reason
  
  left_join(result%>%
              left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs ))%>%
              filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
              select(stop_id, person_id, result))%>%
  
  select(Year, stop_id, person_id, result)%>%
  mutate(Total=n())%>%
  group_by(result)%>%
    mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id))%>%
  rename( 'Result of Stop'='result')%>%
  arrange(-Percent)%>%
  mutate(Assignment='All units')%>% 
  relocate(Assignment, .after = Year)

# repeat above steps for gang suppression unit

result_p_gu<-person%>%
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs, assignment ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0 & assignment == 'Gang enforcement')%>%

  left_join(result%>%
              left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs,assignment ))%>%
              filter(Year=='2022' & stop_in_response_to_cfs == 0 & assignment == 'Gang enforcement')%>%
              select(stop_id, person_id, result))%>%
  
  select(Year, assignment, stop_id, person_id, result)%>%
  mutate(Total=n())%>%
  group_by(result)%>%
    mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id))%>%
  rename( 'Result of Stop'='result',
          'Assignment' = 'assignment')%>%
  arrange(-Percent)

# final combine

result_p<-result_p%>%
  rbind(result_p_gu)

# create table

  flextable(result_p) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Officer-Initiated Stops by Stop Result') %>% 
  theme_vanilla() %>%
  width(j=3,3.65,unit="in")





```

## Stop result by SDPD divisions

Stop result trends vary across SDPD divisions. 

```{r fig.height = 7, fig.width = 13}

result_div<-person%>%
  
  # join person table to beats/stops data so we can filter for year / cfs
  
  left_join(beats_stop%>%select(stop_id, Year, stop_in_response_to_cfs, div_name))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)

# double check the na division names

na<-result_div%>%
  filter(is.na(div_name))%>%
  left_join(stops%>%select(stop_id,  beat))

# table(na$beat) # check what the beat numbers are that have NA division names

# recode the NA division names and join to reasons table. We know that some people show up more than once (multiple rows) when joining the person-results table together because they are stopped and there was more than one result. Example: stop_id=504045. We are OK for now with the slight overcount. You can see that instead of 88,099 rows after joining the results table you get 95,543 because of the multiple results per person for some. 

result_div<-result_div%>%
  mutate(div_name=ifelse(is.na(div_name), 'UNKNOWN DIVISION', div_name)) %>%
  
  left_join(result%>%
              select(stop_id, person_id, result))

# analyze

df<-result_div%>%
  select(Year, div_name, result)%>%
  group_by(div_name)%>%
  mutate(Total=n())%>%
  group_by(div_name, result)%>%
  mutate(Count=n(),
         Percent=Count/Total*100)%>%
  arrange(-Percent,  .by_group = TRUE)%>%
  slice(1)%>%
  mutate(result=ifelse(result %in% 'Warning (verbal or written)','Warning',result))%>% # lets make the warning label shorter
  filter(grepl('No Action|Field interview card completed|Citation for infraction|Warning', result))

# graph

ggplot(df, aes( x = result , y =  Percent) ) + 
      geom_bar( stat = "identity", fill="#362178") + 
  geom_text(aes( label = paste0(round(Percent, digits=1),"%" ),
                 y= Percent),vjust = 1.4, size = 4, color = "white",
             fontface = "bold")+
      facet_wrap( ~ div_name, nrow=2) + 
      xlab("")+
  ylab("Percent of Officer-Initiated Stops (%)")+
    scale_x_discrete(labels = wrap_format(20))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=15),
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=12, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())



```

# Hit Rates

## By police assignment
This analysis looks at what percentage of stops that resulted in a search produced contraband. Approximately 70% of all stops that result in a search do not produce any contraband across all police units and for gang enforcement stops. 

```{r}

# bring in action table to filter for searches, while officers are supposed to record the basis for the search, this doesn't happen reliably
actions<-dbGetQuery(con, "SELECT * FROM rel_actions")

# filter for search actions
actions_search<-actions%>%
  filter(grepl('search|Search', action))

# dedup search actions
actions_search_p<-actions_search%>%
  filter(consented!="N")%>% # take out people where they were asked for a search but no consent provided
  group_by(stop_id,person_id)%>%
  summarise(count_searches=n())

# dedup basis for the search
search_p<-search%>%
  mutate_all(na_if,"")%>%
  filter(!is.na(basis_for_search))%>%
  group_by(stop_id,person_id)%>%
  summarise(count_basis=n())

#join to basis for the search, is it always captured?
actions_search_p<-actions_search_p%>%
  full_join(search_p, by=c("stop_id","person_id"))

sum(is.na(actions_search_p$count_searches)) # 5 nulls based on actions of searches
sum(is.na(actions_search_p$count_basis)) # 9561 based on basis
# use actions for search

actions_search_p<-actions_search_p%>%
  filter(!is.na(count_searches))

# dedup contraband
contra_p<-contra%>%
  filter(contraband!="None")%>%
  group_by(stop_id, person_id)%>%
  summarise(count_contra=n())

# join searches to contraband
search_contra_p<-actions_search_p%>%
  left_join(contra_p)

# make NAs in contraband 0
search_contra_p <- search_contra_p %>% 
          mutate(count_contra = coalesce(count_contra, 0))

# Take searches, filter for year and cf==0 and bring in assignment and division data
search_contra_p<- search_contra_p%>%
  left_join(beats_stop%>%select(stop_id, Year, stop_in_response_to_cfs,assignment,div_name))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  mutate(contraband_found=ifelse(count_contra<1,"None","One or more items found"))%>%
  ungroup()

#### All units analysis ####

# calculate hit rates for all units first
contra_all<-search_contra_p%>%
  mutate(search_total=n())%>%
  group_by(contraband_found)%>%
  summarise(Percent=n()/min(search_total)*100,
            search_total=min(search_total))%>%
  mutate(Year='2022',
         Assignment='All units')%>%
  rename('Contraband'='contraband_found',
         'Search Total'='search_total') %>%
  select(Year, Assignment, Contraband, 'Search Total', Percent)

#### Gang suppression unit ####

# calculate hit rates for gang enforcement next
contra_gu<-search_contra_p%>%
  filter(assignment=='Gang enforcement')%>%
  mutate(search_total=n())%>%
  group_by(contraband_found)%>%
  summarise(Percent=n()/min(search_total)*100,
            search_total=min(search_total))%>%
  mutate(Year='2022',
         Assignment='Gang enforcement')%>%
  rename('Contraband'='contraband_found',
         'Search Total'='search_total') %>%
  select(Year, Assignment, Contraband, 'Search Total', Percent)

#### Final combine and visualize ####

df<-rbind(contra_all, contra_gu)

  flextable(df) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Hit Rate of Stops that Result in Searches') %>% 
  theme_vanilla() %>%
  width(j=3,2,unit="in")


```

## By SDPD division

```{r}

# calculate rates by division
contra_div<-search_contra_p%>%
  group_by(div_name)%>%
  mutate(search_total=n())%>%
  group_by(div_name,contraband_found)%>%
  mutate(Count=n(),
    Percent=Count/search_total*100)%>%
arrange(-Percent,  .by_group = TRUE)%>%
  slice(1)%>%
  select(div_name,contraband_found,Percent)%>%
  mutate(div_name=ifelse(is.na(div_name),"UNKNOWN DIVISION",div_name))

# graph

ggplot(contra_div, aes( x = contraband_found , y =  Percent) ) + 
      geom_bar( stat = "identity", fill="#362178") + 
  geom_text(aes( label = paste0(round(Percent, digits=1),"%" ),
                 y= Percent),vjust = 1.4, size = 4, color = "white",
             fontface = "bold")+
      facet_wrap( ~ div_name, nrow=2) + 
      xlab("")+
  ylab("Percent of Searches by Contraband Found (%)")+
    scale_x_discrete(labels = wrap_format(20))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=15),
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=12, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())
```
# Age Demographics

## Stops by age by poliice assignment 

The gang enforcement unit stops more individuals between the age of 18-34 compared to all police units. 

```{r}
# Note that the numbers might be slightly inflated because there are some people that are indicated as having more than 1 perceived age. But for the purposes of this descriptive analysis we want to see general trends and are OK with some duplicates for the time being. 


# take persons filter for year/cfs, and create age brackets out of perceived age

person_age<-person%>%
  left_join(stops%>%select(stop_id, Year, assignment, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  select(stop_id, person_id, Year, assignment, perceived_age)%>%
  mutate(age_bracket=ifelse(perceived_age <=18, '18 and under',
                      ifelse(perceived_age <=24 & perceived_age>18, '19-24',
                       ifelse(perceived_age <=34 & perceived_age>24, '25-34',
                        ifelse(perceived_age <=44 & perceived_age>34, '35-44',
                       ifelse(perceived_age <=54 & perceived_age>44, '45-54',
                        ifelse(perceived_age <=64 & perceived_age>54, '55-64',
                                ifelse(perceived_age >=65, '65 and older', 'Blank'))))))))

# calculate rates for all units

  person__age_allunit<-person_age%>%
    mutate(Total=n())%>%
    group_by(age_bracket)%>%
      mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id, perceived_age, assignment))%>%
  rename( 'Age'='age_bracket')%>%
  # arrange(-Percent)%>%
  mutate(Assignment='All units')%>% 
  relocate(Assignment, .after = Year)
  
  # calculate rate for gang suppression unit only

   person_age_gu<-person_age%>%
     filter(assignment == 'Gang enforcement')%>%
    mutate(Total=n())%>%
    group_by(age_bracket)%>%
      mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id, perceived_age))%>%
  rename( 'Age'='age_bracket',
          'Assignment'='assignment')
  
  
# final combine
   
   df<-rbind(person__age_allunit, person_age_gu)
   
# create table

  flextable(df) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Officer-Initiated Stops by Age Group') %>% 
  theme_vanilla() %>%
  width(j=2,1.5,unit="in")



```

## Stops by age by SDPD divisions

The Southeastern and Northern divisions disproportionately stops individuals age 25-34 relative to other age groups. 

```{r fig.height = 7, fig.width = 13}

# take the person_age table made in the previous code chunk already filtered for year/cfs and recoded age labels. Join to beats_stops to get division names

age_div<-person_age%>%
  left_join(beats_stop%>%select(stop_id, Year, stop_in_response_to_cfs, div_name))
  
# calculate rates 

  df<-age_div%>%
    group_by(div_name)%>%
    mutate(Total=n())%>%
    group_by(div_name, age_bracket)%>%
      mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)
  
# graph

ggplot(df, aes( x = age_bracket , y =  Percent) ) + 
      geom_bar( stat = "identity", fill="#362178") + 
  geom_text(aes( label = paste0(round(Percent, digits=1),"%" ),
                 y= Percent),vjust = 1.4, size = 3, color = "white",
             fontface = "bold")+
      facet_wrap( ~ div_name, nrow=2) + 
      xlab("")+
  ylab("Percent of Officer-Initiated Stops (%)")+
    scale_x_discrete(labels = wrap_format(10))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=15),
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=12, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())

  
  

```

# Race/Ethnicity Demographics

## Stops by race by police assignment

The gang enforcement unit disproportionately stops Black and Latinx individuals. 

```{r}

#### All Units level analysis ####

# calculate rates for all units: nh_race 

  race_allunit_nh<-race%>%
  left_join(stops%>%select(stop_id, Year, assignment, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  select(Year, nh_race)%>%
    mutate(Total=n())%>%
    group_by(nh_race)%>%
      mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
  rename( 'Race'='nh_race')%>%
  arrange(-Percent)%>%
  mutate(Assignment='All units')%>% 
  relocate(Assignment, .after = Year)%>%
  filter(!grepl('nh_sswana|nh_aian|nh_nhpi', Race))%>%
  drop_na(Race) # drop the row where nh_race = NA because that is for the people with 5+ perceived number of races who were recoded tonh_race = NULL

# calculate rates for all units: mesa/aian/nhpi

 race_allunit_other<-race%>%
  left_join(stops%>%select(stop_id, Year, assignment, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  select(Year, sswana_flag, aian_flag, nhpi_flag)%>%
    mutate(Total=n())%>%
  summarise(Year, 
            Total,
            mesa=sum(sswana_flag, na.rm=TRUE),
            nhpi=sum(nhpi_flag, na.rm=TRUE),
            aian=sum(aian_flag, na.rm=TRUE))%>%
   pivot_longer(3:5, names_to = "Race", values_to="Count" )%>%
   group_by(Race)%>%
   slice(1)%>%
   mutate(Percent=Count/Total*100)%>%
   mutate(Assignment='All units')
 
 
 # fix order of columns
 race_allunit_other<-race_allunit_other[,c(1,6,3,2,4,5)]
 
 # combine: 
 
 race_allunit<-rbind(race_allunit_nh, race_allunit_other)%>%
   arrange(-Percent)
 
 #### Gang Suppression Unit only analysis ####
 
 # calculate rate/count for nh_race only for gang suppression unit

  race_gu_nh<-race%>%
  left_join(stops%>%select(stop_id, Year, assignment, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0 & assignment == 'Gang enforcement')%>%
  select(Year, nh_race, assignment)%>%
    mutate(Total=n())%>%
    group_by(nh_race)%>%
      mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
  rename( 'Race'='nh_race')%>%
  arrange(-Percent)%>%
   rename('Assignment'='assignment')%>%
     relocate(Assignment, .after = Year)%>%
  filter(!grepl('nh_sswana|nh_aian|nh_nhpi', Race))%>%
  drop_na(Race) # drop the row where nh_race = NA because that is for the people with 5+ perceived number of races who were recoded tonh_race = NULL
 
 
 # calculate rates for all units: mesa/aian/nhpi

 race_gu_other<-race%>%
  left_join(stops%>%select(stop_id, Year, assignment, stop_in_response_to_cfs ))%>%
 filter(Year=='2022' & stop_in_response_to_cfs == 0 & assignment == 'Gang enforcement')%>%  select(Year, assignment, sswana_flag, aian_flag, nhpi_flag)%>%
    mutate(Total=n())%>%
  summarise(Year, 
            assignment,
            Total,
            mesa=sum(sswana_flag, na.rm=TRUE),
            nhpi=sum(nhpi_flag, na.rm=TRUE),
            aian=sum(aian_flag, na.rm=TRUE))%>%
   pivot_longer(4:6, names_to = "Race", values_to="Count" )%>%
   group_by(Race)%>%
   slice(1)%>%
   mutate(Percent=Count/Total*100)%>%
   rename('Assignment'='assignment')
 
  # fix order of columns
 race_gu_other<-race_gu_other[,c(1,2,4,3,5,6)]
 
 # combine:
 
 race_gu<-rbind(race_gu_nh, race_gu_other)%>%
   arrange(-Percent)
 
 #### Final combine and visualize table ####
 
 # combine all units + gang suppression unit tables and create race labels
 
 df<-rbind(race_allunit, race_gu)%>%
   mutate(Race=ifelse(Race %in% "nh_white", "White NH",
                 ifelse(Race %in% "nh_black", "Black NH",   
                        ifelse(Race %in% "latinx", "Latinx",
                               ifelse(Race %in% "nh_asian", "Asian NH",
                                      ifelse(Race %in% "mesa", "SSWANA",
                                             ifelse(Race %in% "aian", "AIAN",
                                                    ifelse(Race %in% "nhpi", "NHPI", "Multiracial"))))))))
 
 # create table

  flextable(df) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Officer-Initiated Stops by Race') %>% 
  theme_vanilla() %>%
  width(j=2,1.5,unit="in")


```

## Stops by race by SDPD divisions

The Southeastern division disproportionately stops Black and Latinx individuals relative to other racial groups. The Souther division disproportionately stops Latinx individuals relative to other racial groups. 

```{r fig.height = 7, fig.width = 13}

# calculate rates for nh_race 

  div_race_nh<-race%>%
  left_join(beats_stop%>%select(stop_id, Year, beat, div_name, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)

# explore NA div names

na<-div_race_nh%>%
  filter(is.na(div_name))

# table(na$beat) # what we've been seeing consistently

# continue analysis and recode NA div names

div_race_nh<-div_race_nh%>%
  select(div_name, nh_race)%>%
  mutate(div_name=ifelse(is.na(div_name), "UNKNOWN DIVISION", div_name))%>%
  group_by(div_name)%>%
    mutate(Total=n())%>%
    group_by(div_name, nh_race)%>%
      mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
  rename( 'Race'='nh_race')%>%
  filter(!grepl('nh_mesa|nh_aian|nh_nhpi', Race))%>%
  drop_na(Race) # drop the row where nh_race = NA because that is for the people with 5+ perceived number of races who were recoded to nh_race = NULL


# calculate rates for: mesa/aian/nhpi

 div_race_other<-race%>%
  left_join(beats_stop%>%select(stop_id, Year, div_name, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  select(div_name, mesa_flag, aian_flag, nhpi_flag)%>%
     mutate(div_name=ifelse(is.na(div_name), "UNKNOWN DIVISION", div_name))%>%
   group_by(div_name)%>%
    mutate(Total=n())%>%
  summarise( Total,
            mesa=sum(mesa_flag, na.rm=TRUE),
            nhpi=sum(nhpi_flag, na.rm=TRUE),
            aian=sum(aian_flag, na.rm=TRUE))%>%
   pivot_longer(3:5, names_to = "Race", values_to="Count" )%>%
   group_by(div_name, Race)%>%
   slice(1)%>%
   mutate(Percent=Count/Total*100)
 

 
 # combine: 
 
 df<-rbind(div_race_nh, div_race_other)%>%
   arrange(-Percent)
 
 # modify race labels for graphing
 
 df<-df%>%
   mutate(Race=ifelse(Race %in% "nh_white", "White NH",
                 ifelse(Race %in% "nh_black", "Black NH",   
                        ifelse(Race %in% "latinx", "Latinx",
                               ifelse(Race %in% "nh_asian", "Asian NH",
                                      ifelse(Race %in% "mesa", "SSWANA",
                                             ifelse(Race %in% "aian", "AIAN",
                                                    ifelse(Race %in% "nhpi", "NHPI", "Multiracial"))))))))

 # graph
 
 ggplot(df, aes( x = Race , y =  Percent) ) + 
      geom_bar( stat = "identity", fill="#362178") + 
  geom_text(aes( label = paste0(round(Percent, digits=1),"%" ),
                 y= Percent),vjust = -0.4, size = 4, color ="black", fontface="bold")+
      facet_wrap( ~ div_name, nrow=2) + 
      xlab("")+
  ylab("Percent of Officer-Initiated Stops (%)")+
    scale_x_discrete(labels = wrap_format(10))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=15),
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=15, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())

 


```

# Map of Officer-Initiated Stops

This map shows the count of officer-initiated stops in 2022 by police beat for all police units and for the gang enforcement unit.

```{r}

# prep beats sf so one feature per beat as to not duplicate/double counts per beat later
beats_dissolve<-beats%>%
  mutate(name=ifelse(beat=='511','BARRIO LOGAN',name))%>%
  group_by(beat,name)%>%
  summarise()
  
#### All Units Layer ####

# first summarise count of stops per beat for all units
beats_allunit<-stops%>%
   filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  group_by(beat,beat_name)%>%
  summarise(count=n())%>%
  inner_join(beats_dissolve, by=c("beat"="beat"))%>%
  ungroup
# there are 2 beats in the beat sf (0,9) that have no stops assigned, and 2 beats in the stop data that have no spatial object La Jolla Village and La Playa

# convert for leaflet
beats_allunit<-st_as_sf(beats_allunit)%>%
  st_transform(4326)


#### Gang suppression unit layer ####

# then create the gang suppression unit layer
beats_gu<-stops%>%
   filter(Year=='2022' & stop_in_response_to_cfs == 0 & assignment == 'Gang enforcement')%>%
  group_by(beat,beat_name)%>%
  summarise(count=n())%>%
  inner_join(beats_dissolve, by=c("beat"="beat"))%>%
  ungroup
# there are 2 beats in the beat sf (0,9) that have no stops assigned, and 2 beats in the stop data that have no spatial object La Jolla Village and La Playa

# convert for leaflet
beats_gu<-st_as_sf(beats_gu)%>%
  st_transform(4326)

### Divisional overlay ####

# pull in divisional layer to create an overlay

  
div<-st_read(con, query = "SELECT * FROM sangis_sdpd_divisions_2023")

# transform for leaflet

div<- st_transform(div,4326)

#### Map ####

# set palette
cc_brand <- c("#E2D9FF", "#BDAFE9","#8E7ACA", "#362178","#211447")

#palette purples
pal <- colorQuantile(cc_brand,beats_allunit$count, n = 5)

pal_allunit<-colorBin(
  palette =cc_brand,
  domain = beats_allunit$count,
  bins=c(0,300,600,900,Inf),
   na.color = NA
)

pal_gu<-colorBin(
  palette =cc_brand,
  domain = beats_gu$count,
  bins=c(0,5,10,Inf),
   na.color = NA
)

# popups

popup_allunit<-paste0("Assignment: All Units","<br>","Beat Name: ",beats_allunit$name,"<br>","Stop count: ", beats_allunit$count)

popup_gu<-paste0("Assignment: Gang Suppression Unit","<br>","Beat Name: ",beats_gu$name,"<br>","Stop count: ", beats_gu$count)

div_popup<-paste0(div$div_name)

# legend label

labels_allunit<- c( "0-300", "300-600", "600-900", "Greater than 900")
labels_gu<- c( "0-5", "5-10", "Greater than 10")



# map


leaflet(width = "100%", height = "600px") %>%
  
  addMapPane("gu_pane", zIndex=485)%>%
  addMapPane("allunit_pane", zIndex=485)%>%
    addMapPane("div_pane", zIndex=485)%>%

  

  #  all-units layer
  
  addPolygons(data = beats_allunit,  label=~htmlEscape(paste0("Beat name: ", beats_allunit$name)), color = "#444444", weight = 1, smoothFactor = 0.5,  opacity = 1, fillOpacity =1,  fillColor = ~pal_allunit(beats_allunit$count),
               popup = ~paste0(popup_allunit), 
              highlight = highlightOptions(color = "white", weight = 3, bringToFront = FALSE), group = "All Units",
               options = pathOptions(pane = "allunit_pane")) %>%
  
  # gang suppression unit layer
  
    addPolygons(data = beats_gu,  label=~htmlEscape(paste0("Beat name: ",beats_gu$name)), color = "#444444", weight = 1, smoothFactor = 0.5,  opacity = 1, fillOpacity =1,  fillColor = ~pal_gu(beats_gu$count),
               popup = ~paste0(popup_gu),
              highlight = highlightOptions(color = "white", weight = 3, bringToFront = FALSE), group = "Gang Suppression Unit",
              options = pathOptions(pane = "gu_pane")) %>%
  
  # divisional overlay
  
   addPolygons(data=div, color="#CEEA01", weight = 1.5, smoothFactor = 0.5,
                label=~htmlEscape(paste0("Division name: ",div_popup)),
  
                           opacity = 1.0, fillOpacity = 0, group="SDPD Divisions",
               options = pathOptions(pane = "div_pane"))%>%


 ## add legends for stop count for each layer
  
  addLegend(position = "bottomleft", pal = pal_allunit, values = beats_allunit$count, opacity = .5, title = "All Units", na.label = NA,
            group="All Units",
             labFormat= function(type, cuts, p) {  
                                                  paste0(labels_allunit)
                             }) %>%

  addLegend(position = "bottomleft", pal = pal_gu, values = beats_gu$count, opacity = .5, title = "Gang Suppression Unit", na.label = NA, group="Gang Suppression Unit",
             labFormat= function(type, cuts, p) {  
                                                  paste0(labels_gu)
                             }) %>%

  # layer control
  
   addLayersControl(overlayGroups = c("All Units","Gang Suppression Unit", "SDPD Divisions"),
                   options = layersControlOptions(collapsed = FALSE),
                   position = 'topright')%>%
  
  
  #hide supervisorial districts by default
  hideGroup( "SDPD Divisions","Gang Suppression Unit")%>%
  
  #base and view
  
  addProviderTiles("CartoDB.Positron")

```
