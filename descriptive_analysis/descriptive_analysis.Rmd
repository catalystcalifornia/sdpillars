---
title: "San Diego RIPA Data Pillars Project"
subtitle: "Descriptive Analysis"
author: "Catalyst California"
output:
  html_document:
    css: "W:\\RDA Team\\R\\cc_brandguide.css"
    toc: yes
    toc_depth: 2
    toc_float: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)


list.of.packages <- c("usethis", "highcharter", "tidyverse", "sf", "leaflet", "sp", "htmltools", "magrittr", "flextable", "htmlwidgets")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

#### Load libraries ####
library(usethis)
library(highcharter)
library(tidyverse)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(magrittr)
#library(leaflegend) # customize legends to change shapes:: commenting out because not needed for high injury network maps for now
library(flextable)
library(htmlwidgets)

#add function that better fits the tables to the page    
    FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
    }

#### Add database connection ####

source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("rjs_pillars")

# read in tables from postgres

stops<-dbGetQuery(con, "SELECT * FROM rel_stops") 

# Add column just for year of stop to stops table
stops$Year = substr(stops$date_stop, 1, 4)


reason<-dbGetQuery(con, "SELECT * FROM rel_stopreason")
person<-dbGetQuery(con, "SELECT * FROM rel_persons")
result<-dbGetQuery(con, "SELECT * FROM rel_stopresult")
search<-dbGetQuery(con, "SELECT * FROM rel_basis_search")
contra<-dbGetQuery(con, "SELECT * FROM rel_contrabands_evidences")
race<-dbGetQuery(con, "SELECT * FROM rel_races_recode")

```

Before engaging in detailed analysis regarding the projectâ€™s research questions, we ran general frequencies of SDPD stops to get a sense of overall trends. This helps us determine if our expected findings are likely to show up in the data and allows us to identify any trends we did not expect. The analysis includes: 

General counts and percents of SDPD stops by key fields in RIPA data, e.g., stop reason, stop result, calls for service, race, age, searches, officer assignment. 

General counts and percents of stops by Gang Suppression Unit and Special Operations Unit (if available) by key fields in RIPA data, e.g., stop reason, stop result, calls for service, race, age, searches. 


# Calls for Service versus Officer-initiated

Analysis cut by all unit types:

```{r}

# prep data 

cfs<-stops%>%
  select(stop_id, Year, stop_in_response_to_cfs, stopduration)%>%
  filter(Year=='2022')%>%
  mutate(Total=n())%>%
  group_by(stop_in_response_to_cfs)%>%
  mutate(Count=n(),
         Percent=Count/Total*100,
         'Average Stop Time (Mins)' = mean(stopduration, na.rm = FALSE),
            'Median Stop Time (Mins)'=   median(stopduration,na.rm = FALSE),
             'Min Stop Time (Mins)'=min(stopduration,na.rm = FALSE),
            'Max Stop Time (Mins)'=max(stopduration,na.rm = FALSE),
             'Total Time (Mins)'= sum(stopduration)
         )%>%
  slice(1)%>%
  select(-c(stop_id, stopduration))%>%
  mutate(stop_in_response_to_cfs=ifelse(stop_in_response_to_cfs %in% 0, 'No', 'Yes'))%>%
  rename('Call for Service'='stop_in_response_to_cfs')%>%
  mutate(Assignment = 'All units')%>%
  relocate(Assignment, .after = Year)
         


#create and style flextable

  flextable(cfs) %>% 
colformat_double(j = c("Percent", "Average Stop Time (Mins)",'Median Stop Time (Mins)',
                       'Min Stop Time (Mins)','Max Stop Time (Mins)', 'Total Time (Mins)'), digits = 1)%>% 
  set_caption('Stop Counts and Rates by Response to Service Call for All Units') %>% 
  theme_vanilla() 

```

Analysis filtered for gang suppression unit:

```{r}

# prep data 

cfs_gu<-stops%>%
  select(stop_id, Year, assignment, stop_in_response_to_cfs, stopduration)%>%
  filter(Year=='2022' & assignment =='Gang enforcement')%>%
  mutate(Total=n())%>%
  group_by(stop_in_response_to_cfs)%>%
  mutate(Count=n(),
         Percent=Count/Total*100,
         'Average Stop Time (Mins)' = mean(stopduration, na.rm = FALSE),
            'Median Stop Time (Mins)'=   median(stopduration,na.rm = FALSE),
             'Min Stop Time (Mins)'=min(stopduration,na.rm = FALSE),
            'Max Stop Time (Mins)'=max(stopduration,na.rm = FALSE),
             'Total Time (Mins)'= sum(stopduration)
         )%>%
  slice(1)%>%
  select(-c(stop_id, stopduration))%>%
  mutate(stop_in_response_to_cfs=ifelse(stop_in_response_to_cfs %in% 0, 'No', 'Yes'))%>%
  rename('Call for Service'='stop_in_response_to_cfs',
         'Assignment'='assignment')
         


#create and style flextable

  flextable(cfs_gu) %>% 
colformat_double(j = c("Percent", "Average Stop Time (Mins)",'Median Stop Time (Mins)',
                       'Min Stop Time (Mins)','Max Stop Time (Mins)', 'Total Time (Mins)'), digits = 1)%>% 
  set_caption('Stop Counts and Rates by Response to Service Call for Gang Suppression Unit') %>% 
  theme_vanilla() 

```


## Total Officer-Intiated Stops Over Time

```{r}

# calculate total number of officer initiated stops across all units

count<-stops%>%
  filter(stop_in_response_to_cfs==0)%>%
  select(Year, stop_id)%>%
  group_by(Year)%>%
  mutate('All Units Total'=n())%>%
  slice(1)%>%
  select(-stop_id)

# calculate total number of officer initiated stops for gang suppresion unit

count_gu<-stops%>%
  filter(stop_in_response_to_cfs==0 )%>%
  filter(grepl('Gang enforcement', assignment))%>%
  select(Year, stop_id)%>%
  group_by(Year)%>%
  mutate('Gang Suppression Unit Total'=n())%>%
  slice(1)

# combine both unit tables

count<-count%>%
  left_join(count_gu%>%select(Year, 'Gang Suppression Unit Total'))
  
  #create and style flextable

  flextable(count) %>% 
  set_caption('Total Count of Officer-Initiated Stops Over Time') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in")
  
  
```

## Total Officer-Intiated Stops in 2022

```{r}

units22<-stops%>%
  filter(stop_in_response_to_cfs==0)%>%
  select(Year, stop_id, officer_assignment_key, assignment)%>%
  group_by(Year)%>%
  mutate(Total=n())%>%
  group_by(Year, assignment)%>%
  summarise(Total=Total,
            Count=n(),
            Percent=Count/Total*100)%>%
  slice(1)%>%
  arrange(-Percent)%>%
  rename('Patrol Assignment'='assignment')%>%
  filter(grepl('2022', Year))


#create and style flextable

  flextable(units22) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Stops by Patrol Assignment Type in 2022') %>% 
  theme_vanilla() %>%
  width(j=2,2.5,unit="in")


```


# Stop Reason and Rersults

## Stops by stop reason

```{r}

# for the rel_stopreason table, it seems like the reason why some people show up in multiple rows is because
# there are different values for 'reason_for_stop_text' or 'reason_for_stop_detail' or 'reason_stop_explaination' BUT the 'reason_for_stop' value remains the same. Which is ultimately what we want for our analysis. So my goal is to create a flattened version of rel_stopreason that shows each person once for their stop reason. UNLESS a person shows up more than once because there is more than one unique stop reason

# similarliy seeing now that rel_persons also has multiple rows for people who have more than 1 perceived age or gender


# Continuing analysis for now:

reason_p<-person%>%
  
  # join stops table so we can filter for year / cfs
  
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  
  # left join reasons -filtered for year/cfs - to get stop reason
  
  left_join(reason%>%
              left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs ))%>%
              filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
              select(stop_id, person_id, reason_for_stop))%>%
  
  select(Year, stop_id, person_id, reason_for_stop)

# Run a quick test to see if one person/stop_id combo has more than 1 unique reason_for_stop

test<-reason_p %>%
  group_by(stop_id, person_id) %>% 
  mutate(same = +(n_distinct(reason_for_stop) == 1)) %>% 
  ungroup()

 # table(test$same) # all 90777 rows return same==1 which means there are not any people who were stopped for different reason_for_stop

# Calculate estimates -all units

reason_p<-reason_p%>%
  mutate(Total=n())%>%
  group_by(reason_for_stop)%>%
    mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id))%>%
  rename( 'Reason for stop'='reason_for_stop')%>%
  arrange(-Percent)%>%
  mutate(Assignment='All units')%>% 
  relocate(Assignment, .after = Year)

# Calculate estimates -gang suppression unit only

reason_p_gu<-person%>%
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs, assignment ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0 & assignment == 'Gang enforcement')%>%

  left_join(reason%>%
              left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs,assignment ))%>%
              filter(Year=='2022' & stop_in_response_to_cfs == 0 & assignment == 'Gang enforcement')%>%
              select(stop_id, person_id, reason_for_stop))%>%
  
  select(Year, assignment, stop_id, person_id, reason_for_stop)%>%
  mutate(Total=n())%>%
  group_by(reason_for_stop)%>%
    mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id))%>%
  rename( 'Reason for stop'='reason_for_stop',
          'Assignment' = 'assignment')%>%
  arrange(-Percent)

# final combine

reason_p<-reason_p%>%
  rbind(reason_p_gu)


# create table

  flextable(reason_p) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Officer-Initiated Stops by Stop Reason') %>% 
  theme_vanilla() %>%
  width(j=3,3.65,unit="in")


```

## Stops by stop result

```{r}

# calculate for all gang units

result_p<-person%>%
  
  # join result table to person table so we can filter for year / cfs
  
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  
  # left join results -filtered for year/cfs - to get stop reason
  
  left_join(result%>%
              left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs ))%>%
              filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
              select(stop_id, person_id, result))%>%
  
  select(Year, stop_id, person_id, result)%>%
  mutate(Total=n())%>%
  group_by(result)%>%
    mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id))%>%
  rename( 'Result of Stop'='result')%>%
  arrange(-Percent)%>%
  mutate(Assignment='All units')%>% 
  relocate(Assignment, .after = Year)

# repeat above steps for gang suppression unit

result_p_gu<-person%>%
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs, assignment ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0 & assignment == 'Gang enforcement')%>%

  left_join(result%>%
              left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs,assignment ))%>%
              filter(Year=='2022' & stop_in_response_to_cfs == 0 & assignment == 'Gang enforcement')%>%
              select(stop_id, person_id, result))%>%
  
  select(Year, assignment, stop_id, person_id, result)%>%
  mutate(Total=n())%>%
  group_by(result)%>%
    mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id))%>%
  rename( 'Result of Stop'='result',
          'Assignment' = 'assignment')%>%
  arrange(-Percent)

# final combine

result_p<-result_p%>%
  rbind(result_p_gu)

# create table

  flextable(result_p) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Officer-Initiated Stops by Stop Result') %>% 
  theme_vanilla() %>%
  width(j=3,3.65,unit="in")





```

## Hit Rates

```{r, include=FALSE, eval=FALSE}

# Take searches, filter for year and cf==0 and limit only to where searches took place

search_p<- search%>%
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
mutate_all(na_if,"")%>%
  filter(!is.na(basis_for_search))%>%
  select(Year, stop_id, person_id, basis_for_search)%>%
  group_by(stop_id, person_id)%>%
  mutate(did_search_occur=1)

# Grab  contraband and filter for year and where cfs ==0

contra_p<-contra%>%
  left_join(stops%>%select(stop_id, Year, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  select(Year, stop_id, person_id, contraband)

# join both tables together

hitrate<-full_join(search_p, contra_p)%>%
  m

  


```

# Demographics of Stops

## Stops by age

Note that the numbers might be slightly inflated because there are some people that are indicated as having more than 1 perceived age. But for the purposes of this descriptive analysis we want to see general trends and are OK with some duplicates for the time being. 

```{r}

# take persons filter for year/cfs, and create age brackets out of perceived age

person_age<-person%>%
  left_join(stops%>%select(stop_id, Year, assignment, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  select(stop_id, person_id, Year, assignment, perceived_age)%>%
  mutate(age_bracket=ifelse(perceived_age <=18, '18 and under',
                      ifelse(perceived_age <=24 & perceived_age>18, '19-24',
                       ifelse(perceived_age <=34 & perceived_age>24, '25-34',
                        ifelse(perceived_age <=44 & perceived_age>34, '35-44',
                       ifelse(perceived_age <=54 & perceived_age>44, '45-54',
                        ifelse(perceived_age <=64 & perceived_age>54, '55-64',
                                ifelse(perceived_age >=65, '65 and older', 'Blank'))))))))

# calculate rates for all units

  person__age_allunit<-person_age%>%
    mutate(Total=n())%>%
    group_by(age_bracket)%>%
      mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id, perceived_age, assignment))%>%
  rename( 'Age'='age_bracket')%>%
  # arrange(-Percent)%>%
  mutate(Assignment='All units')%>% 
  relocate(Assignment, .after = Year)
  
  # calculate rate for gang suppression unit only

   person_age_gu<-person_age%>%
     filter(assignment == 'Gang enforcement')%>%
    mutate(Total=n())%>%
    group_by(age_bracket)%>%
      mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
   select(-c(stop_id, person_id, perceived_age))%>%
  rename( 'Age'='age_bracket',
          'Assignment'='assignment')
  
  
# final combine
   
   df<-rbind(person__age_allunit, person_age_gu)
   
# create table

  flextable(df) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Officer-Initiated Stops by Age Group') %>% 
  theme_vanilla() %>%
  width(j=2,1.5,unit="in")



```

## Stops by race

```{r}

#### All Units level analysis ####

# calculate rates for all units: nh_race 

  race_allunit_nh<-race%>%
  left_join(stops%>%select(stop_id, Year, assignment, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  select(Year, nh_race)%>%
    mutate(Total=n())%>%
    group_by(nh_race)%>%
      mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
  rename( 'Race'='nh_race')%>%
  arrange(-Percent)%>%
  mutate(Assignment='All units')%>% 
  relocate(Assignment, .after = Year)%>%
  filter(!grepl('nh_mesa|nh_aian|nh_nhpi', Race))%>%
  drop_na(Race) # drop the row where nh_race = NA because that is for the people with 5+ perceived number of races who were recoded tonh_race = NULL

# calculate rates for all units: mesa/aian/nhpi

 race_allunit_other<-race%>%
  left_join(stops%>%select(stop_id, Year, assignment, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0)%>%
  select(Year, mesa_flag, aian_flag, nhpi_flag)%>%
    mutate(Total=n())%>%
  summarise(Year, 
            Total,
            mesa=sum(mesa_flag, na.rm=TRUE),
            nhpi=sum(nhpi_flag, na.rm=TRUE),
            aian=sum(aian_flag, na.rm=TRUE))%>%
   pivot_longer(3:5, names_to = "Race", values_to="Count" )%>%
   group_by(Race)%>%
   slice(1)%>%
   mutate(Percent=Count/Total*100)%>%
   mutate(Assignment='All units')
 
 
 # fix order of columns
 race_allunit_other<-race_allunit_other[,c(1,6,3,2,4,5)]
 
 # combine: 
 
 race_allunit<-rbind(race_allunit_nh, race_allunit_other)%>%
   arrange(-Percent)
 
 #### Gang Suppression Unit only analysis ####
 
 # calculate rate/count for nh_race only for gang suppression unit

  race_gu_nh<-race%>%
  left_join(stops%>%select(stop_id, Year, assignment, stop_in_response_to_cfs ))%>%
  filter(Year=='2022' & stop_in_response_to_cfs == 0 & assignment == 'Gang enforcement')%>%
  select(Year, nh_race, assignment)%>%
    mutate(Total=n())%>%
    group_by(nh_race)%>%
      mutate(Count=n(),
           Percent=Count/Total*100)%>%
  slice(1)%>%
  rename( 'Race'='nh_race')%>%
  arrange(-Percent)%>%
   rename('Assignment'='assignment')%>%
     relocate(Assignment, .after = Year)%>%
  filter(!grepl('nh_mesa|nh_aian|nh_nhpi', Race))%>%
  drop_na(Race) # drop the row where nh_race = NA because that is for the people with 5+ perceived number of races who were recoded tonh_race = NULL
 
 
 # calculate rates for all units: mesa/aian/nhpi

 race_gu_other<-race%>%
  left_join(stops%>%select(stop_id, Year, assignment, stop_in_response_to_cfs ))%>%
 filter(Year=='2022' & stop_in_response_to_cfs == 0 & assignment == 'Gang enforcement')%>%  select(Year, assignment, mesa_flag, aian_flag, nhpi_flag)%>%
    mutate(Total=n())%>%
  summarise(Year, 
            assignment,
            Total,
            mesa=sum(mesa_flag, na.rm=TRUE),
            nhpi=sum(nhpi_flag, na.rm=TRUE),
            aian=sum(aian_flag, na.rm=TRUE))%>%
   pivot_longer(4:6, names_to = "Race", values_to="Count" )%>%
   group_by(Race)%>%
   slice(1)%>%
   mutate(Percent=Count/Total*100)%>%
   rename('Assignment'='assignment')
 
  # fix order of columns
 race_gu_other<-race_gu_other[,c(1,2,4,3,5,6)]
 
 # combine:
 
 race_gu<-rbind(race_gu_nh, race_gu_other)%>%
   arrange(-Percent)
 
 #### Final combine and visualize table ####
 
 # combine all units + gang suppression unit tables
 
 df<-rbind(race_allunit, race_gu)
 
 # create table

  flextable(df) %>% 
colformat_double(j = c("Percent"), digits = 1)%>% 
  set_caption('Total and Rate of Officer-Initiated Stops by Race') %>% 
  theme_vanilla() %>%
  width(j=2,1.5,unit="in")


```


# Map

Map of stop counts by police beat and for Gang Suppression Unit/Special Operations Unit. 
